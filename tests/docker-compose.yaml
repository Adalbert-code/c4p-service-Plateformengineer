version: "3.8"
services:
  postgresql:
    image: postgres:15-alpine
    restart: always
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    volumes:
      - ../init.sql:/docker-entrypoint-initdb.d/create_tables.sql
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
  kafka:
    image: apache/kafka:3.7.0
    ports:
      - "9094:9094"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@localhost:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
      - KAFKA_NUM_PARTITIONS=1
    healthcheck:
      test: [ "CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list" ]
      interval: 10s
      timeout: 10s
      retries: 10
  init-kafka:
    image: apache/kafka:3.7.0
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: [ '/bin/sh', '-c' ]
    command: |
      "
      # blocks until kafka is reachable
      /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --list
      echo -e 'Creating kafka topics'
      /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --create --topic events-topic --replication-factor 1 --partitions 1

      echo -e 'Successfully created the following topic: events-topic'
      /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --list
      "
  wiremock:
    image: wiremock/wiremock:2.32.0
    ports:
      - "3001:8080"
    volumes:
      - ../wiremock:/home/wiremock
  c4p-service:
    depends_on:
      kafka:
        condition: service_healthy
      postgresql:
        condition: service_healthy
    image: salaboy/c4p-service-a3dc0474cbfa348afcdf47a8eee70ba9:v1.0.0
    environment:
      - KAFKA_URL=kafka:9092
      - POSTGRES_HOST=postgresql
      - AGENDA_SERVICE_URL=http://wiremock:8080
      - NOTIFICATIONS_SERVICE_URL=http://wiremock:8080
    ports:
      - "8080:8080"
volumes:
  kafka_data:
    driver: local
